1、ac01中身份证号重复的人员（2018/04/16）

```sql
--问题
select                
 yac002,count(*)
from ac01
where yac002 is not null
group by yac002 having count(*) > 1
--解决方式
select a.aae036,a.*
from ac01 a
--update ac01 set aae100 = '0'
where aac001 in (
     select aac001 from (
        select distinct aac001  -- 重复的人员
        from ac01
        where yac002 in (select                
                           yac002
                          from ac01
                          where yac002 is not null
                          group by yac002 having count(*) > 1)   --1538  3107
      )
      where aac001 not in(
        select distinct aac001 from (  --使用人员
          select distinct aac001 from uj21 where aac001 is not null
          union all
          select distinct aac001 from uj43 where aac001 is not null
          union all
          select distinct aac001 from UJ49 where aac001 is not null
          union all
          select distinct aac001 from UJ48 where aac001 is not null
          union all
          select distinct aac001 from UJ47 where aac001 is not null
          union all
          select distinct aac001 from UJ44 where aac001 is not null
          union all
          select distinct aac001 from UJ37 where aac001 is not null
          union all
          select distinct aac001 from DZ05 where aac001 is not null
          union all
          select distinct aac001 from DZ03 where aac001 is not null
          union all
          select distinct aac001 from DZ05 where aac001 is not null
          union all
          select distinct aac001 from DY41 where aac001 is not null
          union all
          select distinct aac001 from AEA5 where aac001 is not null
          union all
          select distinct aac001 from AC19 where aac001 is not null
          --union all
          --select distinct aac001 from AEA4 where aac001 is not null
          --union all
          --select distinct aac001 from AC0D where aac001 is not null
          --union all
          --select distinct aac001 from AC0D where aac001 is not null
           --union all
          --select distinct aac001 from DCB8 where aac001 is not null
          --union all
          --select distinct aac001 from DCB4 where aac001 is not null
          --union all
          --select distinct aac001 from DY43 where aac001 is not null
          --union all 
          --select distinct aac001 from DY42 where aac001 is not null
          --union all
          --select distinct aac001 from GCJ5 where aac001 is not null
          --union all
          --select distinct aac001 from DZ08 where aac001 is not null
          --union all
          --select distinct aac001 from uj79 where aac001 is not null
          --union all
          --select distinct aac001 from UJ78 where aac001 is not null
          --union all
          --select distinct aac001 from UJ50 where aac001 is not null
        )
      ) 
) 
--order by a.aae036 desc
```

2、修改大屏的定时任务(2018/04/17)

```sql
    /*-------------------------------------------------------------------------
    || 过程名称： 生成1号大屏幕评价度的数据
    || 功能描述 ：人才服务指挥监控系统：包括窗口满意度
    || 功能描述 ：每分钟重新生成一次
    || 返 回 值 ：
    || 作    者 ：      完成日期 ：
    ||-------------------------------------------------------------------------
    || 修改记录 ：
    ||-------------------------------------------------------------------------*/
   PROCEDURE prc_create_pjd(
                                   PRM_AAE017   IN VARCHAR2,   --经办机构
                                   PRM_AAE011   IN VARCHAR2,   --经办人姓名

                                   prm_appcode  OUT VARCHAR2,  --错误代码
                                   prm_errormsg OUT VARCHAR2)  --错误信息
   ;
   
   /*-------------------------------------------------------------------------
    || 过程名称： 生成所有大屏幕评价度数据
    || 功能描述 ：
    || 返 回 值 ：
    || 作    者 ：      完成日期 ：
    ||-------------------------------------------------------------------------
    || 修改记录 ：
    ||-------------------------------------------------------------------------*/
   PROCEDURE prc_createall_pjd
         ;
```

```sql
/*-------------------------------------------------------------------------
    || 过程名称： 生成1号大屏幕评价度的数据
    || 功能描述 ：人才服务指挥监控系统：包括窗口满意度
    || 功能描述 ：每分钟重新生成一次
    || 返 回 值 ：
    || 作    者 ：      完成日期 ：
    ||-------------------------------------------------------------------------
    || 修改记录 ：
    ||-------------------------------------------------------------------------*/
   PROCEDURE prc_create_pjd(
                                   PRM_AAE017   IN VARCHAR2,   --经办机构
                                   PRM_AAE011   IN VARCHAR2,   --经办人姓名

                                   prm_appcode  OUT VARCHAR2,  --错误代码
                                   prm_errormsg OUT VARCHAR2)  --错误信息
   IS
    s_aae017 varchar2(20)  := PRM_AAE017||'%';     --经办机构编号，如果传入空，则生成所有的机构数据
    n_dpbh NUMBER(4) := 1;   --大屏编号
    d_tjkssj date := sysdate; --统计开始时间
  BEGIN
    PRM_APPCODE  := GN_DEF_OK; --默认过程成功执行没有错
    PRM_ERRORMSG := null; --默认过程没有错误信息

    --插入各中心经办人员数
  BEGIN
      delete from RCDPM05;   --当前各中心工作人员数
      INSERT INTO RCDPM05   --当前各中心工作人员数
      (
       AAE017,             --分中心,VARCHAR2
       RCDPM0501           --工作人员数,NUMBER
      )
      SELECT
        yab003,   --分中心，即经办机构编号
        count(1)  --人数
        FROM tauser a
       where NVL(a.destory,'0')='0'  --未删除
         and NVL(a.JBBZ,'1') = '1' --经办业务标志，领导不经办业务就不参与排名
         AND a.yab003 like s_aae017
         AND a.yab003 in (select yab003 from taorg where NVL(destory,'0')='0')
       group by yab003    --分中心，即经办机构编号
      ;
      INSERT INTO RCDPM05   --当前各中心工作人员数
      (
       AAE017,             --分中心,VARCHAR2
       RCDPM0501           --工作人员数,NUMBER
      )
      SELECT
        yab003,   --分中心，即经办机构编号
        0         --人数
        FROM taorg t
       WHERE orgtype = '01'  --机构类型 机构
         AND NVL(t.destory,'0') = '0'
         AND t.yab003 not in (select aae017 from RCDPM05)
      ;

      --更改分中心名称
      UPDATE RCDPM05
         SET AAE017_DESC = FUN_GETAAE017DESC(AAE017);
    EXCEPTION
      WHEN OTHERS THEN
        PRM_APPCODE  := GN_DEF_ERR;
        PRM_ERRORMSG := '插入各中心经办人员数有误！';
        RETURN;
    END;

    --1、今日窗口满意度
    delete from RCDPM02;   --RCDPM02今日窗口满意度
    INSERT INTO RCDPM02   --RCDPM02今日窗口满意度
    (
     AAE017,             --分中心,VARCHAR2
     RCDPM0202           --工作人员数,NUMBER
    )
    SELECT
      aae017,
      a.rcdpm0501
      FROM rcdpm05 a;  --RCDPM05当前各中心工作人员数
    --更改分中心名称
    UPDATE RCDPM02
       SET AAE017_DESC = FUN_GETAAE017DESC(AAE017);

    UPDATE RCDPM02 a   --RCDPM02今日窗口满意度
       SET
    (
       RCDPM0203,          --非常满意,NUMBER
       RCDPM0204,          --满意,NUMBER
       RCDPM0205,          --态度不好人数,NUMBER
       RCDPM0206,          --效率不高人数,NUMBER
       RCDPM0207,          --业务不熟人数,NUMBER
       RCDPM0208,          --有待改进人数,NUMBER
       RCDPM0209           --没有评价人数,NUMBER
    )
    =
(select
       RCDPM0203,          --非常满意,NUMBER
       RCDPM0204,          --满意,NUMBER
       RCDPM0205,          --态度不好人数,NUMBER
       RCDPM0206,          --效率不高人数,NUMBER
       RCDPM0207,          --业务不熟人数,NUMBER
       RCDPM0208,          --有待改进人数,NUMBER
       RCDPM0209           --没有评价人数,NUMBER
   from
(
    SELECT
      aae017,
      NVL(sum(case when YAEA91 = '11' then 1 else 0 end),0) RCDPM0203,  --非常满意
      NVL(sum(case when YAEA91 = '10' then 1 else 0 end),0) RCDPM0204,  --满意
      NVL(sum(case when YAEA91 = '20' then 1 else 0 end),0) RCDPM0205,  --态度不好
      NVL(sum(case when YAEA91 = '21' then 1 else 0 end),0) RCDPM0206,  --效率不高
      NVL(sum(case when YAEA91 = '22' then 1 else 0 end),0) RCDPM0207,  --业务不熟人数
      NVL(sum(case when YAEA91 = '23' then 1 else 0 end),0) RCDPM0208,  --有待改进人数
      NVL(sum(case when YAEA91 = '30' then 1 else 0 end),0) RCDPM0209   --没有评价人数
      FROM aea9 b  --窗口服务评价
     where b.aae036_ND = TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))
       AND b.aae036_YF = TO_NUMBER(TO_CHAR(SYSDATE,'MM'))
       AND b.aae036_DAY = TO_NUMBER(TO_CHAR(SYSDATE,'DD'))
       AND aae017 like s_aae017
     group by aae017   --机构
) c
 where a.aae017 = c.aae017
)
;
  EXCEPTION
    WHEN OTHERS THEN
      PRM_APPCODE  := GN_DEF_ERR;
      PRM_ERRORMSG := '生成'||gs_dpm_1||'出错！'|| SQLERRM || '!出错行数：' || DBMS_UTILITY.FORMAT_ERROR_BACKTRACE();
      RETURN;
  END prc_create_pjd;
  
  
  /*-------------------------------------------------------------------------
    || 过程名称： 生成所有大屏幕评价度数据
    || 功能描述 ：
    || 返 回 值 ：
    || 作    者 ：      完成日期 ：
    ||-------------------------------------------------------------------------
    || 修改记录 ：
    ||-------------------------------------------------------------------------*/
   PROCEDURE prc_createall_pjd  --错误信息
   IS
     PRM_AAE017 varchar2(2) := '%';
     PRM_AAE011 varchar2(20) := '管理员';
     PRM_APPCODE VARCHAR2(200);
     PRM_ERRORMSG VARCHAR2(500);
  BEGIN
    PRM_APPCODE  := GN_DEF_OK; --默认过程成功执行没有错
    PRM_ERRORMSG := ''; --默认过程没有错误信息

    --生成1号大屏幕数据
    BEGIN
      prc_create_pjd(PRM_AAE017,PRM_AAE011,prm_appcode,prm_errormsg);
      if prm_appcode != gn_def_ok then
        RETURN;
      end if;
    EXCEPTION
      --没有数据
      WHEN OTHERS THEN
        PRM_APPCODE  := GN_DEF_ERR;
        PRM_ERRORMSG := '生成 '||gs_dpm_1||'中的评价度信息时出错！'|| SQLERRM || '!出错行数：' || DBMS_UTILITY.FORMAT_ERROR_BACKTRACE();
        RETURN;
    END;
  EXCEPTION
    WHEN OTHERS THEN
      PRM_APPCODE  := GN_DEF_ERR;
      PRM_ERRORMSG := '生成大屏幕统计数据时出错，'|| SQLERRM || '!出错行数：' || DBMS_UTILITY.FORMAT_ERROR_BACKTRACE();
      RETURN;
  END prc_createall_pjd;
```

```sql
begin
  sys.dbms_scheduler.create_job(job_name            => 'JYRC.JOB_DPM_CREATE_PJD',
                                job_type            => 'STORED_PROCEDURE',
                                job_action          => 'pkg_jyrc_dpmzs.prc_createall_pjd',
                                start_date          => to_date('22-02-2018 00:00:00', 'dd-mm-yyyy hh24:mi:ss'),
                                repeat_interval     => 'Freq=Minutely;Interval=1',
                                end_date            => to_date(null),
                                job_class           => 'DEFAULT_JOB_CLASS',
                                enabled             => true,
                                auto_drop           => false,
                                comments            => '');
end;
```

3、删除政务办测试数据

```sql
select * from pre_apasinfo where servicename = '人事代理手续办理'

select *  from pre_apasinfo
where projid in ('4108000271806112000001','4108000271806112000002','4108000271806112000003','4108000271806112000004');

select *  from pre_accept
where projid in ('4108000271806112000001','4108000271806112000002','4108000271806112000003','4108000271806112000004');

select *   from pre_attr
where projid in ('4108000271806112000001','4108000271806112000002','4108000271806112000003','4108000271806112000004');

select *  from pre_node
where projid in ('4108000271806112000001','4108000271806112000002','4108000271806112000003','4108000271806112000004');

select *  from pre_transact
where projid in ('4108000271806112000001','4108000271806112000002','4108000271806112000003','4108000271806112000004');


```

4、验证迁移社保数据个人信息是否已办理业务

```sql
select distinct aac001 from ( 
  select distinct aac001 from uj21 where aac001 is not null
  union all
  select distinct aac001 from uj43 where aac001 is not null
  union all
  select distinct aac001 from UJ49 where aac001 is not null
  union all
  select distinct aac001 from UJ48 where aac001 is not null
  union all
  select distinct aac001 from UJ47 where aac001 is not null
  union all
  select distinct aac001 from UJ44 where aac001 is not null
  union all
  select distinct aac001 from UJ37 where aac001 is not null
  union all
  select distinct aac001 from DZ05 where aac001 is not null
  union all
  select distinct aac001 from DZ03 where aac001 is not null
  union all
  select distinct aac001 from DZ05 where aac001 is not null
  union all
  select distinct aac001 from DY41 where aac001 is not null
  union all
  select distinct aac001 from AEA5 where aac001 is not null
  union all
  select distinct aac001 from AC19 where aac001 is not null
  union all
  select distinct aac001 from AEA4 where aac001 is not null
  union all
  select distinct aac001 from AC0D where aac001 is not null
  union all
  select distinct aac001 from AC0D where aac001 is not null
   union all
  select distinct aac001 from DCB8 where aac001 is not null
  union all
  select distinct aac001 from DCB4 where aac001 is not null
  union all
  select distinct aac001 from DY43 where aac001 is not null
  union all 
  select distinct aac001 from DY42 where aac001 is not null
  union all
  select distinct aac001 from GCJ5 where aac001 is not null
  union all
  select distinct aac001 from DZ08 where aac001 is not null
  union all
  select distinct aac001 from uj79 where aac001 is not null
  union all
  select distinct aac001 from UJ78 where aac001 is not null
) 
where aac001 in (select aac001 from ac01 where aae036 is not null and yae100 = '社保数据迁移');
```

5、验证迁移单位数据是否已使用

```sql
select distinct aab001 
from (
select distinct aab001
  from aea4 where aab001 is not null
union all
select distinct aab001
  from aea5_ls where aab001 is not null
union all  
select distinct aab001
  from ea03 where aab001 is not null
union all
select distinct aab001
  from ea04 where aab001 is not null
union all
select distinct aab001
  from tausermgdept where aab001 is not null
union all
select distinct aab001
  from uj41 where aab001 is not null
union all
select distinct aab001
  from uj43 where aab001 is not null
union all
select distinct aab001
  from uj45 where aab001 is not null
union all
select distinct aab001
  from uj46 where aab001 is not null
union all
select distinct aab001
  from uj48 where aab001 is not null)
where aab001 in (select aab001 from ab01 where yae116 = '1' and to_char(aae036,'yyyymmdd') = '20180625');  
```

```sql
--4883
delete from ac01 where yae100 = '社保数据迁移';
--140
delete from ab01 where yae116 = '1' and to_char(aae036,'yyyymmdd') = '20180625';

```

```sql
-- 去除毕业院校和专业中的空格
update uj21 
set yuj215 = trim(yuj215)
where length(yuj215) != length(trim(yuj215));
update uj21 
set yac139 = trim(yac139)
where length(yac139) != length(trim(yac139));

update ac01 
set yac139 = trim(yac139)
where length(yac139) != length(trim(yac139));
update ac01 
set aac180 = trim(aac180)
where length(aac180) != length(trim(aac180));
```

```sql
--恢复社保导入数据覆盖的信息
insert into ac01(aac001,aac003,aac180,aac181,yac139,aac011,aae100,yae100,yae091,aae017,yae116,aae011,aae036,aae163,yac404)
select a.aac001,c.aac003,a.yuj215,a.yuj217,a.yac139,a.aac011,'1','03','2',a.aae017,a.yae116,a.aae011,a.aae036,a.aae036,'1' from uj21 a
left join ac01 b on a.aac001 = b.aac001
join aea5 c on a.aac001 = c.aac001
where  b.aac001 is null and c.menuname='档案接收_新增'
```

6、修改档案号重复问题

![1531188672272](E:\typora\images\1531188672272.png)



档案号重复，重新设置新的档案号

| 流水号   | 档案位置  | 姓名   | 旧档案号     | 新档案号     |
| -------- | --------- | ------ | ------------ | ------------ |
| 20002627 | 40-A1-106 | 屈喆   | JZ0801073819 | JZ0801076114 |
| 20002929 | 32-A2-043 | 杨莹   | JZ0801074120 | JZ0801076115 |
| 20001882 | 41-A1-009 | 李纯   | JZ0801073125 | JZ0801076116 |
| 20002472 | 40-A1-031 | 郭孟帆 | JZ0801073668 | JZ0801076117 |
| 20004762 | 32-B1-049 | 廉雪峰 | JZ0801075936 | JZ0801076118 |
| 20002394 | 32-A1-007 | 许卫谦 | JZ0801073599 | JZ0801076119 |
| 20004066 | 42-D2-065 | 王豪   | JZ0801075253 | JZ0801076120 |

```sql
-- JZ0801075253 20004066
--1.修改档案号
update uj21
set yuj031 = 'JZ0801076120'  --新档案号
where yuj210 = '20004066';
--2.修改档案号的状态
update uh09 
set yae159 = '1',
    yuh056 = (select aae036 from uj21 where yuj230 = '10' and yuj210 = '20004066')
where yuj031 = 'JZ0801076120' --新档案号
  and yuh040 = '1';  

-- JZ0801073599 20002394
--1.修改档案号
update uj21
set yuj031 = 'JZ0801076119'  --新档案号
where yuj210 = '20002394';
--2.修改档案号的状态
update uh09 
set yae159 = '1',
    yuh056 = (select aae036 from uj21 where yuj230 = '10' and yuj210 = '20002394')
where yuj031 = 'JZ0801076119' --新档案号
  and yuh040 = '1';  

-- JZ0801075936 20004762
--1.修改档案号
update uj21
set yuj031 = 'JZ0801076118'  --新档案号
where yuj210 = '20004762';
--2.修改档案号的状态
update uh09 
set yae159 = '1',
    yuh056 = (select aae036 from uj21 where yuj230 = '10' and yuj210 = '20004762')
where yuj031 = 'JZ0801076118' --新档案号
  and yuh040 = '1';  

-- JZ0801073668 20002472
--1.修改档案号
update uj21
set yuj031 = 'JZ0801076117'  --新档案号
where yuj210 = '20002472';
--2.修改档案号的状态
update uh09 
set yae159 = '1',
    yuh056 = (select aae036 from uj21 where yuj230 = '10' and yuj210 = '20002472')
where yuj031 = 'JZ0801076117' --新档案号
  and yuh040 = '1';  

-- JZ0801073819 20002627
--1.修改档案号
update uj21
set yuj031 = 'JZ0801076114'  --新档案号
where yuj210 = '20002627';
--2.修改档案号的状态
update uh09 
set yae159 = '1',
    yuh056 = (select aae036 from uj21 where yuj230 = '10' and yuj210 = '20002627')
where yuj031 = 'JZ0801076114' --新档案号
  and yuh040 = '1';
  
-- JZ0801074120 20002929
--1.修改档案号
update uj21
set yuj031 = 'JZ0801076115'  --新档案号
where yuj210 = '20002929';
--2.修改档案号的状态
update uh09 
set yae159 = '1',
    yuh056 = (select aae036 from uj21 where yuj230 = '10' and yuj210 = '20002929')
where yuj031 = 'JZ0801076115' --新档案号
  and yuh040 = '1';  
  
-- JZ0801073125 20001882
--1.修改档案号
update uj21
set yuj031 = 'JZ0801076116'  --新档案号
where yuj210 = '20001882';
--2.修改档案号的状态
update uh09 
set yae159 = '1',
    yuh056 = (select aae036 from uj21 where yuj230 = '10' and yuj210 = '20001882')
where yuj031 = 'JZ0801076116' --新档案号
  and yuh040 = '1';  
  
 
```

```sql
-- 查询重复的档案人员
select a.yuj210,a.yuj031,a.yuh060,a.yuj230,a.aae036,b.aac003,b.aac002
from uj21 a
left join ac01 b on a.aac001 = b.aac001
where yuj031 in (select yuj031
from uj21
where yuj230 != 50
group by yuj031 
having count(1) > 1);

--验证新使用的档案号是否使用
select * from uj21 
where yuj031 in ('JZ0801076114','JZ0801076115','JZ0801076116','JZ0801076117','JZ0801076118','JZ0801076119','JZ0801076120');
```

```sql
--2018-07-23 应用户需求删除吴晶河南理工的数据记录，删除掉的记录如下
insert into uj21 (YUJ210, YUJ031, YUJ211, YUH040, YUH050, YUH051, YUH052, YUH053, YUH060, YUJ214, AAC001, YUJ215, YUJ217, YUJ218, YAC139, AAC011, YUJ219, YUJ222, AAB004, YUJ237, AAC007, YUJ223, YUJ224, YUJ227, YAC702, YUJ228, YUJ229, YAC711, YUJ225, YUJ226, YUJ244, YUJ247, YUJ248, YUJ233, YUJ245, YUJ246, YUF051, YUF059, YUJ230, YUJ231, YUJ234, AAE017, YAE116, AAE011, AAE036, YUJ235, YUJ236, YUJ273, AAE013)
values (2315479, 'JZ0802007670', '20121344', '1', null, null, null, null, null, null, 2295346, '河南理工大学', to_date('01-07-2012', 'dd-mm-yyyy'), null, null, '21', 4.0, null, null, '9', null, '4', '1', '1', to_date('01-06-2011', 'dd-mm-yyyy'), to_date('01-06-2012', 'dd-mm-yyyy'), null, null, null, to_date('11-08-2016 13:50:17', 'dd-mm-yyyy hh24:mi:ss'), null, null, null, null, null, null, null, null, '32', null, null, '410800', 1, '系统管理员', to_date('11-08-2016 13:50:17', 'dd-mm-yyyy hh24:mi:ss'), null, null, null, null);
```









